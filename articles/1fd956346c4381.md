---
title: "PHPUnitでスタブとモックを理解する！【テストダブル】"
emoji: "🐡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["PHPUnit", "Mock", "Stub"]
published: false
---

# はじめに

なんとなく言葉だけ使っている「モックとスタブ」。
「ただスタブとモックって何？」と言われると言語化できない、、、。
今回は、実際にPHPUnitでテストコードを書いてみて、スタブとモックの違いについて理解していきたいと思います。

※ソースコードはこちら

## 実行環境

PHP 8.0
PHPUnit 9.5

※実際に触ってみたい方はこちらの記事で実行環境を作成してください。
https://zenn.dev/shun57/articles/4b2cbf33255de4

##　PHPUnitのドキュメントをみると

PHPUnitのドキュメントを確認すると、`8.テストダブル`という章があり、そこでスタブとモックの説明がされています。
つまり、スタブもモックも`テストダブル`のひとつのようです。

テストダブル・・・？
聞きなれない言葉ですね、まずこの言葉から調べてみます。

https://phpunit.readthedocs.io/ja/latest/test-doubles.html


# テストダブルとは？

まずWikipediaを見てみると以下のような記載があります。
`依存コンポーネントのダミーとなる`、いわゆるスタブとモックのイメージのまんまですね。
さらに詳しく調べてみます。

>テストダブル (Test Double) とは、ソフトウェアテストにおいて、テスト対象が依存しているコンポーネントを置き換える代用品のこと。
> 「テストダブル」（2022年5月8日 (日) 18:00）『ウィキペディア日本語版』。https://ja.wikipedia.org/wiki/%E3%83%86%E3%82%B9%E3%83%88%E3%83%80%E3%83%96%E3%83%AB

## xUnit PatternsのTest Doubleパターン

PHPUnitのドキュメント`8.テストダブル`を読むと、最初に`Gerard Meszaros氏`の引用文章があります。
このGerard Meszaros氏のサイトをみてみると、以下`5つのテストダブルパターン`が挙げられています。

:::message
テストダブルの定義はこちらがデファクトスタンダードではなく、他の考え方もあるようです。
:::

- Test Double
http://xunitpatterns.com/Test%20Double.html

1. ダミーオブジェクト
2. テストスタブ
3. テストスパイ
4. モックオブジェクト
5. フェイクオブジェクト

※ スタブとモック以外のテストダブルについては説明は割愛しますので、気になる方は上記サイトをご参照ください。


**つまり、スタブとモックはテストダブルパターンのひとつであり、依存コンポーネントを置き換えるための手法のひとつであることがわかりました。**

# そもそも依存とは？

スタブとモックを理解する上で、そもそも依存について理解しておく必要がありますので、触れておきます。
※ 損なん当たり前にわかるぜ！って方は読み飛ばしてください。

## 依存

あるコンポーネントAを動かすために、他のコンポーネントBが必要であることを、AはBに`依存している(依存関係にある)`といいます。

具体例を見てみましょう。
以下のコンポーネントに依存関係はあるでしょうか？

```php
function sumOfArraySomeTimesZero(array $nums): int
{
    try {
        $check_nums = new CheckNumsClass();
        // ランダムでエラーを返すメソッド
        $result = $check_nums->somtimesError();

        return sumOfArray($nums);
    } catch (Throwable $e) {
        return 0;
    }
}
```

答えは、依存関係があります。
`sumOfArraySomeTimesZero`関数の出力が、`sometimesError`メソッドの出力に左右されているからです。
実行するたびに、sometimesErrorがエラーを返す可能性があり、エラーが返された場合は0を返します。

例えば、このロジックを単体テストしようとするとどうでしょうか？
出力が定まらないので、全てのテストケースを網羅できないですよね？
[1, 2]を与えたときに3が出力されるのか、0が出力されるのかランダムだからです。

この依存コンポーネントに左右されずに単体テストを実施するために、テストダブルパターンを使います。

# テストスタブとは？


# モックオブジェクトとは？


# まとめ